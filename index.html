<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>LumoNet - Messagerie</title>
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: #e0f7fa;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }

    header {
      padding: 20px;
      text-align: center;
      background: #00796b;
      color: white;
      font-size: 1.5em;
      font-weight: bold;
    }

    .screen {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      width: 100%;
      position: relative;
      padding: 20px;
      box-sizing: border-box;
    }

    .add-contact-btn {
      margin-bottom: 20px;
    }

    .add-contact-btn button {
      padding: 10px 20px;
      border: none;
      border-radius: 16px;
      background: #00796b;
      color: white;
      cursor: pointer;
      font-weight: bold;
      transition: background 0.3s;
    }

    .add-contact-btn button:hover {
      background: #004d40;
    }

    .contacts {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 20px;
      width: 90%;
      max-width: 600px;
    }

    .contact-card {
      background: white;
      padding: 30px 10px;
      border-radius: 16px;
      box-shadow: 0 6px 18px rgba(0,0,0,0.08);
      text-align: center;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
      font-size: 1.2em;
      font-weight: bold;
      color: #00796b;
      position: relative;
    }

    .contact-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 25px rgba(0,0,0,0.15);
    }

    .contact-card .delete-btn {
      position: absolute;
      top: 5px;
      right: 8px;
      background: none;
      border: none;
      font-size: 1em;
      color: red;
      cursor: pointer;
    }

    .chat {
      display: none;
      flex-direction: column;
      justify-content: flex-end;
      height: 100%;
      width: 100%;
    }

    .messages {
      flex: 1;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 10px;
      width: 100%;
      margin-bottom: 20px;
    }

    .message {
      max-width: 70%;
      padding: 10px 15px;
      border-radius: 16px;
      background: #fff;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      word-wrap: break-word;
    }

    .message.me {
      align-self: flex-end;
      background: #00796b;
      color: white;
    }

    .chat-input {
      display: flex;
      gap: 10px;
      width: 100%;
    }

    .chat-input input {
      flex: 1;
      padding: 10px;
      border-radius: 16px;
      border: 1px solid #00796b;
      font-size: 16px;
    }

    .chat-input button {
      padding: 10px 20px;
      border: none;
      border-radius: 16px;
      background: #00796b;
      color: white;
      cursor: pointer;
      transition: background 0.3s;
      font-weight: bold;
    }

    .chat-input button:hover {
      background: #004d40;
    }

    .back-btn {
      position: absolute;
      top: 20px;
      left: 20px;
      padding: 10px 15px;
      border: none;
      border-radius: 16px;
      background: #00796b;
      color: white;
      cursor: pointer;
      transition: background 0.3s;
    }

    .back-btn:hover {
      background: #004d40;
    }

    .popup {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      padding: 30px;
      border-radius: 16px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.2);
      z-index: 100;
      width: 90%;
      max-width: 400px;
      text-align: center;
    }

    .popup h2 {
      margin-top: 0;
    }

    .popup input {
      width: 80%;
      padding: 10px;
      margin: 10px 0;
      border-radius: 16px;
      border: 1px solid #00796b;
      font-size: 16px;
    }

    .popup button {
      padding: 10px 20px;
      border: none;
      border-radius: 16px;
      background: #00796b;
      color: white;
      cursor: pointer;
      font-weight: bold;
    }

    .popup button:hover {
      background: #004d40;
    }

    .popup .close-btn {
      position: absolute;
      top: 10px;
      right: 15px;
      font-size: 1.5em;
      cursor: pointer;
      background: none;
      border: none;
      color: #00796b;
    }

    @media(max-width:500px) {
      .contact-card { padding: 20px 5px; font-size: 1em; }
      .chat-input input, .chat-input button, .popup input { font-size: 14px; padding: 8px; }
    }
  </style>
</head>
<body>

<header>LumoNet</header>

<!-- Popup ajout contact -->
<div class="popup" id="popupAddContact">
  <button class="close-btn" onclick="popupAddContact.style.display='none'">×</button>
  <h2>Ajouter un contact</h2>
  <input type="text" id="popupName" placeholder="Nom du contact">
  <input type="text" id="popupToken" placeholder="Token Bark">
  <br>
  <button id="popupAddBtn">Ajouter</button>
</div>

<!-- Écran contacts -->
<div class="screen" id="contactsScreen">
  <div class="add-contact-btn">
    <button onclick="popupAddContact.style.display='block'" title="Ajouter contact">➕ Ajouter un contact</button>
  </div>
  <div class="contacts" id="contactsList"></div>
</div>

<!-- Écran chat -->
<div class="screen chat" id="chatScreen">
  <button class="back-btn" id="backBtn">← Retour</button>
  <h2 id="welcome"></h2>
  <div class="messages" id="messages"></div>
  <div class="chat-input">
    <input type="text" id="chatMessage" placeholder="Tape ton message ici !">
    <button id="sendBtn">Envoyer</button>
  </div>
</div>

<script>
const ICON_URL = "https://i.imgur.com/youricon.png";

// Liste des utilisateurs + avatars
const utilisateurs = {
  nathan: "https://i.postimg.cc/MKKbzJbY/default-avatar.jpg",
  denis: "https://i.postimg.cc/MKKbzJbY/default-avatar.jpg",
  estelle: "https://i.postimg.cc/MKKbzJbY/default-avatar.jpg"
};

// Récupérer ou définir l'utilisateur actuel
let currentUserName = localStorage.getItem('currentUserName');
if (!currentUserName) {
  currentUserName = prompt("Entrez votre nom d'utilisateur :") || "Utilisateur";
  localStorage.setItem('currentUserName', currentUserName);
}

// Normaliser le nom pour correspondre aux clés utilisateurs
const currentUserKey = currentUserName.toLowerCase();
let currentUserAvatar = utilisateurs[currentUserKey] || "https://i.postimg.cc/MKKbzJbY/default-avatar.jpg";
localStorage.setItem('currentUserAvatar', currentUserAvatar);

// Utilisateur encodé pour URL Day.app
const currentUser = encodeURIComponent(currentUserKey);

let contacts = JSON.parse(localStorage.getItem('contacts')) || [];
let currentRecipientToken = '';
let currentRecipientName = '';

const contactsList = document.getElementById('contactsList');
const contactsScreen = document.getElementById('contactsScreen');
const chatScreen = document.getElementById('chatScreen');
const messagesContainer = document.getElementById('messages');
const chatMessageInput = document.getElementById('chatMessage');
const welcome = document.getElementById('welcome');
const backBtn = document.getElementById('backBtn');

// Popup ajout contact
const popupAddContact = document.getElementById('popupAddContact');
const popupName = document.getElementById('popupName');
const popupToken = document.getElementById('popupToken');
const popupAddBtn = document.getElementById('popupAddBtn');

function renderContacts() {
  contactsList.innerHTML = '';
  contacts.forEach((contact, index) => {
    const card = document.createElement('div');
    card.className = 'contact-card';
    card.textContent = contact.name;
    card.dataset.token = contact.token;

    const deleteBtn = document.createElement('button');
    deleteBtn.textContent = "×";
    deleteBtn.className = "delete-btn";
    deleteBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      contacts.splice(index, 1);
      localStorage.setItem('contacts', JSON.stringify(contacts));
      renderContacts();
    });
    card.appendChild(deleteBtn);

    card.addEventListener('click', () => openChat(contact));
    contactsList.appendChild(card);
  });
}

function openChat(contact) {
  currentRecipientToken = contact.token;
  currentRecipientName = contact.name;
  contactsScreen.style.display = 'none';
  chatScreen.style.display = 'flex';
  messagesContainer.innerHTML = '';
  welcome.textContent = `Chat avec ${contact.name}`;
}

function addMessage(text, me = true) {
  const msgDiv = document.createElement('div');
  msgDiv.className = 'message ' + (me ? 'me' : '');
  msgDiv.textContent = text;
  messagesContainer.appendChild(msgDiv);
  messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

function sendMessage() {
  const message = chatMessageInput.value.trim();
  if (!message || !currentRecipientToken) { alert('Écris un message !'); return; }
  addMessage(message, true);

  const token = encodeURIComponent(currentRecipientToken);
  const msg = encodeURIComponent(message);
  const icon = encodeURIComponent(currentUserAvatar);
  const url = `https://api.day.app/${token}/${currentUser}/${msg}?icon=${icon}`;

  const iframe = document.createElement('iframe');
  iframe.style.display = 'none';
  iframe.src = url;
  document.body.appendChild(iframe);

  chatMessageInput.value = '';
  setTimeout(() => document.body.removeChild(iframe), 5000);
}

// Ajouter un contact via popup
popupAddBtn.addEventListener('click', () => {
  const name = popupName.value.trim();
  const token = popupToken.value.trim();
  if (!name || !token) { alert('Nom et token obligatoires !'); return; }

  contacts.push({ name, token });
  localStorage.setItem('contacts', JSON.stringify(contacts));
  popupName.value = '';
  popupToken.value = '';
  popupAddContact.style.display = 'none';
  renderContacts();

  // Notification Bark avec avatar de l'utilisateur actuel
  const msg = encodeURIComponent(`Le contact ${name} a été ajouté par ${currentUserName} ! ✅`);
  const icon = encodeURIComponent(currentUserAvatar);
  const url = `https://api.day.app/${token}/${currentUser}/${msg}?icon=${icon}`;
  const iframe = document.createElement('iframe');
  iframe.style.display = 'none';
  iframe.src = url;
  document.body.appendChild(iframe);
  setTimeout(() => document.body.removeChild(iframe), 5000);
});

// Bouton retour
backBtn.addEventListener('click', () => {
  chatScreen.style.display = 'none';
  contactsScreen.style.display = 'flex';
  currentRecipientToken = '';
  currentRecipientName = '';
});

// Envoyer message avec Enter
chatMessageInput.addEventListener('keydown', e => { if (e.key === 'Enter') sendMessage(); });
document.getElementById('sendBtn').addEventListener('click', sendMessage);

renderContacts();


</script>

</body>
</html>
