<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Zilo - Test</title>
</head>
<body>

<h1>Zilo - Test</h1>

<div id="contactsScreen">
  <button class="contact-card" data-name="denis">Denis</button>
  <button class="contact-card" data-name="nathan">Nathan</button>
</div>

<div id="chatScreen" style="display:none;">
  <button id="backBtn">← Retour</button>
  <h2 id="welcome"></h2>
  <div id="messages"></div>
  <input type="text" id="chatMessage" placeholder="Tape ton message ici !" />
  <button id="sendBtn" type="button">Envoyer</button>
</div>

<script>
const contactsScreen = document.getElementById('contactsScreen');
const chatScreen = document.getElementById('chatScreen');
const messagesContainer = document.getElementById('messages');
const chatMessage = document.getElementById('chatMessage');
const welcome = document.getElementById('welcome');

let currentRecipient = '';

document.querySelectorAll('.contact-card').forEach(card => {
  card.addEventListener('click', () => {
    currentRecipient = card.dataset.name.toLowerCase();
    contactsScreen.style.display = 'none';
    chatScreen.style.display = 'block';
    messagesContainer.innerHTML = '';
    welcome.textContent = `Chat avec ${card.dataset.name}`;
    console.log("Destinataire sélectionné :", currentRecipient);
  });
});

document.getElementById('backBtn').addEventListener('click', () => {
  chatScreen.style.display = 'none';
  contactsScreen.style.display = 'block';
  currentRecipient = '';
});

function addMessage(text, me=true){
  const msgDiv = document.createElement('div');
  msgDiv.textContent = text;
  msgDiv.style.color = me ? 'green' : 'blue';
  messagesContainer.appendChild(msgDiv);
}

async function send() {
  const message = chatMessage.value.trim();
  if (!message) return alert('Écris un message !');
  if (!currentRecipient) return alert('Destinataire non sélectionné !');

  addMessage(message, true);
  chatMessage.value = '';

  console.log("Envoi au backend :", { recipient: currentRecipient, message });

  try {
    const res = await fetch('/api/send', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ recipient: currentRecipient, message })
    });
    const data = await res.json();
    console.log("Réponse serveur :", data);
    if (!data.ok) alert('Erreur : ' + (data.error || 'inconnue'));
  } catch(e) {
    console.error("Erreur fetch :", e);
    alert("Erreur réseau");
  }
}

document.getElementById('sendBtn').addEventListener('click', send);
chatMessage.addEventListener('keydown', e => { if(e.key==='Enter') send(); });
</script>

</body>
</html>
